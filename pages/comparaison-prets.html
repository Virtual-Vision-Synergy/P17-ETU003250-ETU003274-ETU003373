<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Système Bancaire Étudiant - Comparaison de Prêts</title>

    <!-- Bootstrap 5 CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <!-- Font Awesome pour les icônes -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">

    <style>
        .hero-section {
            background: linear-gradient(rgba(0, 0, 0, 0.6), rgba(0, 0, 0, 0.6)), url('https://images.unsplash.com/photo-1554224155-6726b3ff858f?ixlib=rb-1.2.1&auto=format&fit=crop&w=1350&q=80');
            background-size: cover;
            background-position: center;
            color: white;
            padding: 60px 0;
        }

        .comparison-card {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border-radius: 10px;
            padding: 2rem;
            margin-bottom: 2rem;
            box-shadow: 0 10px 30px rgba(0,0,0,0.1);
        }

        .loan-details {
            background: white;
            border-radius: 10px;
            padding: 1.5rem;
            margin-bottom: 1rem;
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
        }

        .loan-details h5 {
            color: #495057;
            border-bottom: 2px solid #007bff;
            padding-bottom: 0.5rem;
            margin-bottom: 1rem;
        }

        .comparison-table {
            background: white;
            border-radius: 10px;
            overflow: hidden;
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
        }

        .comparison-table th {
            background: #007bff;
            color: white;
            text-align: center;
            font-weight: 600;
        }

        .comparison-table td {
            text-align: center;
            vertical-align: middle;
            padding: 1rem;
        }

        .better-value {
            background-color: #d4edda !important;
            color: #155724;
            font-weight: bold;
        }

        .worse-value {
            background-color: #f8d7da !important;
            color: #721c24;
        }

        .metric-card {
            background: white;
            border-radius: 10px;
            padding: 1.5rem;
            text-align: center;
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
            transition: transform 0.3s ease;
        }

        .metric-card:hover {
            transform: translateY(-5px);
        }

        .metric-value {
            font-size: 2rem;
            font-weight: bold;
            color: #007bff;
        }

        .metric-label {
            color: #6c757d;
            font-size: 0.9rem;
            margin-top: 0.5rem;
        }

        .recommendation-card {
            background: linear-gradient(135deg, #28a745 0%, #20c997 100%);
            color: white;
            border-radius: 10px;
            padding: 1.5rem;
            margin-top: 2rem;
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
        }

        .form-section {
            background: white;
            border-radius: 10px;
            padding: 2rem;
            margin-bottom: 2rem;
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
        }
    </style>
</head>

<body>
<!-- Navigation -->
<nav class="navbar navbar-expand-lg navbar-dark bg-primary">
    <div class="container">
        <a class="navbar-brand" href="../index.html">
            <i class="fas fa-university me-2"></i>
            Système Bancaire Étudiant
        </a>
        <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav">
            <span class="navbar-toggler-icon"></span>
        </button>
        <div class="collapse navbar-collapse" id="navbarNav">
            <ul class="navbar-nav me-auto">
                <li class="nav-item">
                    <a class="nav-link" href="../index.html">Accueil</a>
                </li>
                <li class="nav-item">
                    <a class="nav-link" href="etudiants.html">Étudiants</a>
                </li>
                <li class="nav-item">
                    <a class="nav-link" href="etablissements.html">Établissements</a>
                </li>
                <li class="nav-item">
                    <a class="nav-link" href="types-prets.html">Types de Prêts</a>
                </li>
                <li class="nav-item">
                    <a class="nav-link" href="prets.html">Prêts</a>
                </li>
                <li class="nav-item">
                    <a class="nav-link" href="remboursements.html">Remboursements</a>
                </li>
                <li class="nav-item">
                    <a class="nav-link active" href="comparaison-prets.html">Comparaison</a>
                </li>
                <li class="nav-item">
                    <a class="nav-link" href="transactions.html">Transactions</a>
                </li>
            </ul>
        </div>
    </div>
</nav>

<!-- Section Hero -->
<section class="hero-section">
    <div class="container text-center">
        <h1 class="display-4 mb-4">
            <i class="fas fa-balance-scale me-3"></i>
            Comparaison de Prêts
        </h1>
        <p class="lead">
            Comparez deux prêts étudiants pour prendre la meilleure décision financière
        </p>
    </div>
</section>

<!-- Contenu Principal -->
<div class="container mt-5">
    <!-- Formulaire de saisie manuelle -->
    <div class="form-section">
        <h3 class="mb-4">
            <i class="fas fa-edit me-2"></i>
            Saisir les données des prêts à comparer
        </h3>
        <form id="form-comparaison">
            <div class="row">
                <div class="col-md-6">
                    <div class="card">
                        <div class="card-header bg-primary text-white">
                            <h5 class="mb-0"><i class="fas fa-file-alt me-2"></i>Prêt 1</h5>
                        </div>
                        <div class="card-body">
                            <div class="mb-3">
                                <label for="pret1_nom" class="form-label">Nom du prêt</label>
                                <input type="text" class="form-control" id="pret1_nom" placeholder="Ex: Prêt étudiant A" required>
                            </div>
                            <div class="mb-3">
                                <label for="pret1_montant" class="form-label">Montant (€)</label>
                                <input type="number" class="form-control" id="pret1_montant" step="0.01" min="0" placeholder="Ex: 10000" required>
                            </div>
                            <div class="mb-3">
                                <label for="pret1_taux" class="form-label">Taux d'intérêt (%)</label>
                                <input type="number" class="form-control" id="pret1_taux" step="0.01" min="0" max="100" placeholder="Ex: 3.5" required>
                            </div>
                            <div class="mb-3">
                                <label for="pret1_duree" class="form-label">Durée (mois)</label>
                                <input type="number" class="form-control" id="pret1_duree" min="1" placeholder="Ex: 24" required>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="col-md-6">
                    <div class="card">
                        <div class="card-header bg-info text-white">
                            <h5 class="mb-0"><i class="fas fa-file-alt me-2"></i>Prêt 2</h5>
                        </div>
                        <div class="card-body">
                            <div class="mb-3">
                                <label for="pret2_nom" class="form-label">Nom du prêt</label>
                                <input type="text" class="form-control" id="pret2_nom" placeholder="Ex: Prêt étudiant B" required>
                            </div>
                            <div class="mb-3">
                                <label for="pret2_montant" class="form-label">Montant (€)</label>
                                <input type="number" class="form-control" id="pret2_montant" step="0.01" min="0" placeholder="Ex: 15000" required>
                            </div>
                            <div class="mb-3">
                                <label for="pret2_taux" class="form-label">Taux d'intérêt (%)</label>
                                <input type="number" class="form-control" id="pret2_taux" step="0.01" min="0" max="100" placeholder="Ex: 4.0" required>
                            </div>
                            <div class="mb-3">
                                <label for="pret2_duree" class="form-label">Durée (mois)</label>
                                <input type="number" class="form-control" id="pret2_duree" min="1" placeholder="Ex: 36" required>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <div class="text-center mt-4">
                <button type="button" class="btn btn-primary btn-lg" onclick="compareManualLoans()">
                    <i class="fas fa-balance-scale me-2"></i>Comparer les Prêts
                </button>
                <button type="button" class="btn btn-secondary btn-lg ms-2" onclick="resetForm()">
                    <i class="fas fa-undo me-2"></i>Réinitialiser
                </button>
            </div>
        </form>
    </div>

    <!-- Résultats de la comparaison -->
    <div id="comparison-results" style="display: none;">
        <!-- Détails des prêts -->
        <div class="row">
            <div class="col-md-6">
                <div class="loan-details">
                    <h5><i class="fas fa-file-alt me-2"></i>Détails du Prêt 1</h5>
                    <div id="loan1-details">
                        <!-- Détails du prêt 1 -->
                    </div>
                </div>
            </div>
            <div class="col-md-6">
                <div class="loan-details">
                    <h5><i class="fas fa-file-alt me-2"></i>Détails du Prêt 2</h5>
                    <div id="loan2-details">
                        <!-- Détails du prêt 2 -->
                    </div>
                </div>
            </div>
        </div>

        <!-- Métriques clés -->
        <div class="row mb-4">
            <div class="col-md-3">
                <div class="metric-card">
                    <div class="metric-value" id="metric-difference">0%</div>
                    <div class="metric-label">Différence de Coût</div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="metric-card">
                    <div class="metric-value" id="metric-savings">0€</div>
                    <div class="metric-label">Économies Potentielles</div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="metric-card">
                    <div class="metric-value" id="metric-duration">0 mois</div>
                    <div class="metric-label">Différence de Durée</div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="metric-card">
                    <div class="metric-value" id="metric-monthly">0€</div>
                    <div class="metric-label">Différence Mensuelle</div>
                </div>
            </div>
        </div>

        <!-- Tableau de comparaison -->
        <div class="table-responsive comparison-table">
            <table class="table table-striped mb-0">
                <thead>
                    <tr>
                        <th>Critère</th>
                        <th>Prêt 1</th>
                        <th>Prêt 2</th>
                        <th>Avantage</th>
                    </tr>
                </thead>
                <tbody id="comparison-table-body">
                    <!-- Résultats de comparaison -->
                </tbody>
            </table>
        </div>

        <!-- Recommandation -->
        <div class="recommendation-card">
            <h4><i class="fas fa-lightbulb me-2"></i>Recommandation</h4>
            <div id="recommendation-text">
                <!-- Texte de recommandation -->
            </div>
        </div>
    </div>
</div>

<!-- Bootstrap 5 JS -->
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>

<script>
    const API_BASE = '/P17-ETU003250-ETU003274-ETU003373/ws';
    let loan1Data = null;
    let loan2Data = null;

    // Initialisation
    document.addEventListener('DOMContentLoaded', function() {
        // loadLoansForComparison();
    });

    function formatCurrency(amount) {
        return new Intl.NumberFormat('fr-FR', {
            style: 'currency',
            currency: 'EUR'
        }).format(amount);
    }

    function formatPercentage(value) {
        return new Intl.NumberFormat('fr-FR', {
            style: 'percent',
            minimumFractionDigits: 2
        }).format(value / 100);
    }

    async function loadLoansForComparison() {
        try {
            const response = await fetch(`${API_BASE}/prets`);
            const result = await response.json();

            const select1 = document.getElementById('select_pret_1');
            const select2 = document.getElementById('select_pret_2');

            select1.innerHTML = '<option value="">Sélectionner un prêt...</option>';
            select2.innerHTML = '<option value="">Sélectionner un prêt...</option>';

            if (result.success && result.data.length > 0) {
                result.data.forEach(pret => {
                    const option = document.createElement('option');
                    option.value = pret.id;
                    option.innerHTML = `${pret.etudiant_prenom} ${pret.etudiant_nom} - ${pret.type_pret} - ${formatCurrency(pret.montant_accorde)}`;
                    option.dataset.pret = JSON.stringify(pret);

                    select1.appendChild(option.cloneNode(true));
                    select2.appendChild(option);
                });
            } else {
                select1.innerHTML = '<option value="">Aucun prêt trouvé</option>';
                select2.innerHTML = '<option value="">Aucun prêt trouvé</option>';
            }
        } catch (error) {
            console.error('Erreur:', error);
            document.getElementById('select_pret_1').innerHTML = '<option value="">Erreur de chargement</option>';
            document.getElementById('select_pret_2').innerHTML = '<option value="">Erreur de chargement</option>';
        }
    }

    async function compareLoans() {
        const pret1Id = document.getElementById('select_pret_1').value;
        const pret2Id = document.getElementById('select_pret_2').value;

        if (!pret1Id || !pret2Id) {
            alert('Veuillez sélectionner deux prêts à comparer');
            return;
        }

        if (pret1Id === pret2Id) {
            alert('Veuillez sélectionner deux prêts différents');
            return;
        }

        try {
            // Récupérer les données des prêts sélectionnés
            const pret1Option = document.querySelector(`#select_pret_1 option[value="${pret1Id}"]`);
            const pret2Option = document.querySelector(`#select_pret_2 option[value="${pret2Id}"]`);

            loan1Data = JSON.parse(pret1Option.dataset.pret);
            loan2Data = JSON.parse(pret2Option.dataset.pret);

            // Simuler les calculs pour chaque prêt
            const simulation1 = await simulateLoan(loan1Data);
            const simulation2 = await simulateLoan(loan2Data);

            // Afficher les résultats
            displayLoanDetails(loan1Data, simulation1, 'loan1-details');
            displayLoanDetails(loan2Data, simulation2, 'loan2-details');
            displayComparisonTable(loan1Data, loan2Data, simulation1, simulation2);
            displayMetrics(simulation1, simulation2);
            displayRecommendation(loan1Data, loan2Data, simulation1, simulation2);

            document.getElementById('comparison-results').style.display = 'block';
        } catch (error) {
            console.error('Erreur:', error);
            alert('Erreur lors de la comparaison: ' + error.message);
        }
    }

    async function compareManualLoans() {
        // Récupérer les valeurs des formulaires
        const pret1 = {
            nom: document.getElementById('pret1_nom').value,
            montant: parseFloat(document.getElementById('pret1_montant').value),
            taux: parseFloat(document.getElementById('pret1_taux').value),
            duree: parseInt(document.getElementById('pret1_duree').value)
        };

        const pret2 = {
            nom: document.getElementById('pret2_nom').value,
            montant: parseFloat(document.getElementById('pret2_montant').value),
            taux: parseFloat(document.getElementById('pret2_taux').value),
            duree: parseInt(document.getElementById('pret2_duree').value)
        };

        // Validation des données
        if (isNaN(pret1.montant) || isNaN(pret1.taux) || isNaN(pret1.duree) ||
            isNaN(pret2.montant) || isNaN(pret2.taux) || isNaN(pret2.duree)) {
            alert('Veuillez entrer des valeurs valides pour tous les champs');
            return;
        }

        try {
            // Simulation des prêts
            const simulation1 = await simulateLoan({
                montant_accorde: pret1.montant,
                taux_interet: pret1.taux,
                duree_mois: pret1.duree
            });

            const simulation2 = await simulateLoan({
                montant_accorde: pret2.montant,
                taux_interet: pret2.taux,
                duree_mois: pret2.duree
            });

            // Affichage des résultats
            displayLoanDetails(pret1, simulation1, 'loan1-details');
            displayLoanDetails(pret2, simulation2, 'loan2-details');
            displayComparisonTable(pret1, pret2, simulation1, simulation2);
            displayMetrics(simulation1, simulation2);
            displayRecommendation(pret1, pret2, simulation1, simulation2);

            document.getElementById('comparison-results').style.display = 'block';
        } catch (error) {
            console.error('Erreur:', error);
            alert('Erreur lors de la comparaison: ' + error.message);
        }
    }

    async function simulateLoan(pret) {
        try {
            const response = await fetch(`${API_BASE}/remboursements/simuler`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    capital: parseFloat(pret.montant_accorde),
                    taux_annuel: parseFloat(pret.taux_interet),
                    duree_mois: parseInt(pret.duree_mois)
                })
            });

            const result = await response.json();
            if (result.success) {
                return result.data.simulation;
            } else {
                throw new Error(result.message);
            }
        } catch (error) {
            console.error('Erreur simulation:', error);
            // Simulation basique en cas d'erreur
            const tauxMensuel = parseFloat(pret.taux_interet) / 100 / 12;
            const duree = parseInt(pret.duree_mois);
            const capital = parseFloat(pret.montant_accorde);

            const annuite = capital * (tauxMensuel * Math.pow(1 + tauxMensuel, duree)) / (Math.pow(1 + tauxMensuel, duree) - 1);
            const montantTotal = annuite * duree;
            const coutCredit = montantTotal - capital;

            return {
                capital: capital,
                taux_annuel: parseFloat(pret.taux_interet),
                duree_mois: duree,
                annuite: annuite,
                montant_total: montantTotal,
                cout_credit: coutCredit
            };
        }
    }

    function displayLoanDetails(pret, simulation, containerId) {
        const container = document.getElementById(containerId);
        container.innerHTML = `
            <div class="row">
                <div class="col-6">
                    <p><strong>Nom:</strong> ${pret.nom}</p>
                    <p><strong>Montant:</strong> ${formatCurrency(pret.montant || pret.montant_accorde)}</p>
                    <p><strong>Taux:</strong> ${formatPercentage(pret.taux || pret.taux_interet)}</p>
                </div>
                <div class="col-6">
                    <p><strong>Durée:</strong> ${pret.duree || pret.duree_mois} mois</p>
                    <p><strong>Annuité:</strong> ${formatCurrency(simulation.annuite)}</p>
                    <p><strong>Coût total:</strong> ${formatCurrency(simulation.cout_credit)}</p>
                </div>
            </div>
        `;
    }

    function displayComparisonTable(pret1, pret2, sim1, sim2) {
        const tbody = document.getElementById('comparison-table-body');
        tbody.innerHTML = '';

        const comparisons = [
            {
                critere: 'Montant Accordé',
                pret1: formatCurrency(pret1.montant || pret1.montant_accorde),
                pret2: formatCurrency(pret2.montant || pret2.montant_accorde),
                better: (pret1.montant || pret1.montant_accorde) > (pret2.montant || pret2.montant_accorde) ? 1 : 2
            },
            {
                critere: 'Taux d\'Intérêt',
                pret1: formatPercentage(pret1.taux || pret1.taux_interet),
                pret2: formatPercentage(pret2.taux || pret2.taux_interet),
                better: (pret1.taux || pret1.taux_interet) < (pret2.taux || pret2.taux_interet) ? 1 : 2
            },
            {
                critere: 'Durée',
                pret1: `${pret1.duree || pret1.duree_mois} mois`,
                pret2: `${pret2.duree || pret2.duree_mois} mois`,
                better: (pret1.duree || pret1.duree_mois) < (pret2.duree || pret2.duree_mois) ? 1 : 2
            },
            {
                critere: 'Annuité Mensuelle',
                pret1: formatCurrency(sim1.annuite),
                pret2: formatCurrency(sim2.annuite),
                better: sim1.annuite < sim2.annuite ? 1 : 2
            },
            {
                critere: 'Montant Total',
                pret1: formatCurrency(sim1.montant_total),
                pret2: formatCurrency(sim2.montant_total),
                better: sim1.montant_total < sim2.montant_total ? 1 : 2
            },
            {
                critere: 'Coût du Crédit',
                pret1: formatCurrency(sim1.cout_credit),
                pret2: formatCurrency(sim2.cout_credit),
                better: sim1.cout_credit < sim2.cout_credit ? 1 : 2
            }
        ];

        comparisons.forEach(comp => {
            const row = document.createElement('tr');
            const pret1Class = comp.better === 1 ? 'better-value' : comp.better === 2 ? 'worse-value' : '';
            const pret2Class = comp.better === 2 ? 'better-value' : comp.better === 1 ? 'worse-value' : '';

            row.innerHTML = `
                <td><strong>${comp.critere}</strong></td>
                <td class="${pret1Class}">${comp.pret1}</td>
                <td class="${pret2Class}">${comp.pret2}</td>
                <td>
                    ${comp.better === 1 ? '<i class="fas fa-arrow-left text-success"></i> Prêt 1' :
                      comp.better === 2 ? 'Prêt 2 <i class="fas fa-arrow-right text-success"></i>' :
                      '<i class="fas fa-equals text-warning"></i> Égalité'}
                </td>
            `;
            tbody.appendChild(row);
        });
    }

    function displayMetrics(sim1, sim2) {
        const costDifference = Math.abs(sim1.cout_credit - sim2.cout_credit);
        const costPercentage = (costDifference / Math.min(sim1.cout_credit, sim2.cout_credit)) * 100;
        const durationDifference = Math.abs(sim1.duree_mois - sim2.duree_mois);
        const monthlyDifference = Math.abs(sim1.annuite - sim2.annuite);

        document.getElementById('metric-difference').textContent = `${costPercentage.toFixed(1)}%`;
        document.getElementById('metric-savings').textContent = formatCurrency(costDifference);
        document.getElementById('metric-duration').textContent = `${durationDifference} mois`;
        document.getElementById('metric-monthly').textContent = formatCurrency(monthlyDifference);
    }

    function displayRecommendation(pret1, pret2, sim1, sim2) {
        const container = document.getElementById('recommendation-text');
        let recommendation = '';

        if (sim1.cout_credit < sim2.cout_credit) {
            const savings = sim2.cout_credit - sim1.cout_credit;
            recommendation = `
                <p><strong>Recommandation: Prêt 1 (${pret1.nom})</strong></p>
                <p>Le premier prêt est plus avantageux avec des économies de ${formatCurrency(savings)} sur le coût total du crédit.</p>
                <ul>
                    <li>Coût total inférieur: ${formatCurrency(sim1.cout_credit)} vs ${formatCurrency(sim2.cout_credit)}</li>
                    <li>Annuité mensuelle: ${formatCurrency(sim1.annuite)}</li>
                    <li>Économies mensuelles: ${formatCurrency(sim2.annuite - sim1.annuite)}</li>
                </ul>
            `;
        } else if (sim2.cout_credit < sim1.cout_credit) {
            const savings = sim1.cout_credit - sim2.cout_credit;
            recommendation = `
                <p><strong>Recommandation: Prêt 2 (${pret2.nom})</strong></p>
                <p>Le deuxième prêt est plus avantageux avec des économies de ${formatCurrency(savings)} sur le coût total du crédit.</p>
                <ul>
                    <li>Coût total inférieur: ${formatCurrency(sim2.cout_credit)} vs ${formatCurrency(sim1.cout_credit)}</li>
                    <li>Annuité mensuelle: ${formatCurrency(sim2.annuite)}</li>
                    <li>Économies mensuelles: ${formatCurrency(sim1.annuite - sim2.annuite)}</li>
                </ul>
            `;
        } else {
            recommendation = `
                <p><strong>Recommandation: Équivalents</strong></p>
                <p>Les deux prêts ont un coût total similaire. Le choix peut se baser sur d'autres critères comme la durée ou l'annuité mensuelle.</p>
                <ul>
                    <li>Considérez la durée: ${pret1.duree || pret1.duree_mois} mois vs ${pret2.duree || pret2.duree_mois} mois</li>
                    <li>Considérez l'annuité mensuelle: ${formatCurrency(sim1.annuite)} vs ${formatCurrency(sim2.annuite)}</li>
                </ul>
            `;
        }

        container.innerHTML = recommendation;
    }

    function resetForm() {
        document.getElementById('form-comparaison').reset();
        document.getElementById('comparison-results').style.display = 'none';
    }
</script>
</body>
</html>
